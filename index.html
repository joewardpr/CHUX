<!doctype html>
<html>
<head>

	<title>CHUX: Chat App Demo</title>

	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">

	<link rel="stylesheet" href="chux.css">

	<script src="moment.min.js"></script>
	
	<script src="https://cdn.firebase.com/js/client/2.3.1/firebase.js"></script>
	<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js'></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>	

</head>

<body>

<div class='container'>

	<div class='row'>
	<!--NAVBAR-->
		<div class="col-lg-12">
			<div class='alertsBox'>10 New</div>
			<div class='channelIcon'>&nbsp;</div>
			<div class='usersIcon'>&nbsp;</div>
		</div>
	</div>

	<div class='row messageInputRow'>
		<div class='col-lg-9'>
			

			<div id='chatBoxArea' style='display: none;'>
				<div id='loggedUser'></div>
				<div>&nbsp;</div>
				

				<input type='hidden' id='nameInput'>
				<input type='hidden' id='avatarURL'>
				<input class='messageInputBox' id='messageInput' placeholder='What is up?'>
			</div>

		

		</div>
		<div class='col-lg-3' id='channelsList'>#channels</div>
	</div>

	<!-- Message list limited to 400px. Then it becomes scrollable. -->
	<div class='row'>
		<div class='col-lg-9' id='messagesDiv' style='overflow: scroll; height: 400px'></div>
	</div>



<script>

	function deleteChatMessage(postid) {
		chatDB.child('messages').child(postid).remove()
	}  

	function logout(){
		chatDB.unauth()
		$('#messagesDiv').html('')
		$('#loggedUser').html('<a href="/" role="button" class="btn btn-primary btn-xs">Login with Twitter</a>')
		$('#messageInput').hide()
		$('#channelsList').hide()

	}

	var chatDB = new Firebase('https://intense-torch-4337.firebaseio.com')

	// Testing authentication with Twitter
	chatDB.authWithOAuthPopup("twitter", function(error, authData) {
	  
	  if (error) {
	  	console.log("Login Failed!", error)

	  } else {
	    console.log("Authenticated successfully with payload:", authData)

		if (chatDB.getAuth()){
			console.log("User is authenticated")
			// Show the main chat area
			$('#chatBoxArea').show()
		}
		else {
			console.log("User is not authenticated")
			// Hide the main chat area
			$('#chatBoxArea').hide()
		}

	      twitterUsername = authData.twitter.username
	      twitterAvatarURL = authData.twitter.profileImageURL

	      $('#loggedUser').html('Logged in as @' + twitterUsername + ' <a href="javascript:logout()" role="button" class="btn btn-danger btn-xs">Logout</a>')

	      $('#nameInput').val('@' + twitterUsername)
	      $('#avatarURL').val(twitterAvatarURL)

	      // Display the current logged in user's avatar in the input box
	      $('#messageInput').css('background-image', 'url(' + twitterAvatarURL + ')').css('background-size','24px 24px');



		  // Listen for the ENTER key.
		  // When hit, get user name and message
		  // Add it to Firebase
		  // Firebase will throw a child_added event
		  $('#messageInput').keypress(function (e) {
		    if (e.keyCode == 13) {
		      var name = $('#nameInput').val()
		      var text = $('#messageInput').val()
		      var avatarURL = $('#avatarURL').val()
		      var timestamp = Date.now()
		      chatDB.child('messages').push({name: name, text: text, dateAdded: timestamp, avatarURL: avatarURL})
		      $('#messageInput').val('')
		    }
		  })

		  // Update the chat message list when a new message is added
		  // The data will contain the new message only
		  chatDB.child('messages').on('child_added', function(data) {

		    var message = data.val()
		    var messageKey = data.key()
		    displayChatMessage(message.name, message.text, message.avatarURL, message.dateAdded, messageKey)

		  })

	      // Update the chat message list when a post is deleted.
	      // The data will contain only the deleted post.
	      // We will get all the post data to redisplay the list.
	      //
	      // Note: Another method would be to use Jquery to find and selective remove only
	      // the deleted post from the list (without updating the entire list)
	      chatDB.child('messages').on('child_removed', function(data) {

	      	chatDB.once('value', function (data) {

				$('#messagesDiv').html('') // Clear the current messages
	      		if (data.val() !== null) {
	      		
					var messages = data.val().messages

					$.each(messages, function(key, msg) {
						displayChatMessage(msg.name, msg.text, msg.avatarURL, msg.dateAdded, key)
					})
				}

	      	})
	      })

	      // This listener will run everytime a change is made to the data
	      chatDB.child('messages').on('value', function(data) {
	      	// Placeholder; TBD
	      })

	      // Add a single message to the list (div) by appending it to current data.
	      // It scrolls the page to the last message.
	      function displayChatMessage(name, text, avatarURL, dateAdded, postid) {
	        
			if (postid) {
			    //var deleteLink = '[<a href="' + postid + '">x</a>]'
			    var deleteLink = '<a href="javascript:deleteChatMessage(\'' + postid + '\');"><span class="glyphicon glyphicon-remove"></span></a>'
			}
			else{
				var deleteLink = ''
			}

			var theDate = new Date(dateAdded);
			dateString = theDate.toGMTString();

			var m = moment(theDate).fromNow()

			msgRow = "<div class='row' style='margin-top: 16px'>"
			msgRow += "<div class='col-sm-1 postAvatar'>"


			msgRow += "<a href='#' data-toggle='tooltip' data-placement='right' title='" + name + "' class='steel-tooltip'><img class='postAvatar img-circle' src='" + avatarURL + "'></a>"
			msgRow += "</div>"
			msgRow += "<!--<div class='col-sm-1 postUsername'>"
			msgRow += "<span class='label label-info'>" + name + "</span></div>-->"
			msgRow += "<div class='col-sm-7 postText'>" + text + "</div>"
			msgRow += "<div class='col-sm-2 postTimeText'>" + ' ' + m + "</div>"
			msgRow += "<div class='col-sm-1 postDeleteLink'>" + deleteLink +  "</div>"
			msgRow += "</div>"

			

			$('<div/>').html(msgRow).prepend($('<em/>').html('')).appendTo($('#messagesDiv'))
	        $('#messagesDiv')[0].scrollTop = $('#messagesDiv')[0].scrollHeight

	        // Must activate the tool tips each time the message list is updated
	        $(function () {
        		$("[data-toggle='tooltip']").tooltip();
    		});
	      }


	  }

	})


</script>

</body>
</html>